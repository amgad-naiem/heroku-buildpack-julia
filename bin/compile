#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# parse args
BUILD_DIR=$1
CACHE_DIR=$2

BP_DIR=`cd $(dirname $0); cd ..; pwd`

JULIA_VERSION="0.3.0"
JULIA_DIST="julia-${JULIA_VERSION}"
JULIA_DIST_TAR="julia-v0.3.0_768187890c.tar.gz"
JULIA_DIST_TAR_URL="https://github.com/JuliaLang/julia/releases/download/v0.3.0/${JULIA_DIST_TAR}"
JULIA_HOME="${BUILD_DIR}/.julia"

[ ! -d ${CACHE_DIR} ] && mkdir -p ${CACHE_DIR}

# Download Julia if not in cache
if [ ! -f ${CACHE_DIR}/${JULIA_DIST_TAR} ]; then
  echo -n "-----> Downloading ${JULIA_DIST}....."
  curl --silent --location ${JULIA_DIST_TAR_URL} > ${CACHE_DIR}/${JULIA_DIST_TAR}
  echo " done"
fi

echo -n "-----> Installing ${JULIA_DIST}...."

# Untar Julia
cd ${BUILD_DIR}
tar -zxf ${CACHE_DIR}/${JULIA_DIST_TAR}
mv ${JULIA_DIST} ${JULIA_HOME}
echo " done"

if [ "${PIPESTATUS[*]}" != "0" ]; then
  echo " !     Failed to install ${JULIA_DIST}"
  exit 1
fi
