#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# parse args
BUILD_DIR=$1
CACHE_DIR=$2

BP_DIR=`cd $(dirname $0); cd ..; pwd`

JULIA_VERSION="v0.3.0"
JULIA_DIST="julia-v0.3.0"
JULIA_DIST_TAR="julia-v0.3.0.tar.gz"
JULIA_DIST_TAR_URL="https://github.com/JuliaLab/heroku-buildpack-julia/releases/download/0.3.0/${JULIA_DIST_TAR}"
JULIA_HOME="${BUILD_DIR}/.julia"

[ ! -d ${CACHE_DIR} ] && mkdir -p ${CACHE_DIR}

# Download Julia if not in cache
if [ ! -f ${CACHE_DIR}/${JULIA_DIST_TAR} ]; then
  echo -n "-----> Downloading ${JULIA_DIST}....."
  curl --silent --location ${JULIA_DIST_TAR_URL} > ${CACHE_DIR}/${JULIA_DIST_TAR}
  echo " done"
fi

echo -n "-----> Installing ${JULIA_DIST}...."

# Untar Julia
cd ${BUILD_DIR}
tar -zxf ${CACHE_DIR}/${JULIA_DIST_TAR}
mv ${JULIA_DIST} ${JULIA_HOME}
echo " done"

if [ "${PIPESTATUS[*]}" != "0" ]; then
  echo " !     Failed to install ${JULIA_DIST}"
  exit 1
fi

echo -n "-----> Installing system dependencies...."

deps="https://launchpad.net/~staticfloat/+archive/ubuntu/juliareleases/+files/julia_0.3.0-1189~ubuntu12.04.1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/b/boost1.54/libboost-filesystem1.54.0_1.54.0-4ubuntu3.1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/b/boost1.54/libboost-program-options1.54.0_1.54.0-4ubuntu3.1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/b/boost1.54/libboost-regex1.54.0_1.54.0-4ubuntu3.1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/b/boost1.54/libboost-system1.54.0_1.54.0-4ubuntu3.1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/b/boost1.54/libboost-thread1.54.0_1.54.0-4ubuntu3.1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/universe/u/uw-imap/libc-client2007e_2007f~dfsg-2_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/e/elfutils/libelf1_0.159-3ubuntu1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/g/gflags/libgflags2_2.0-1ubuntu1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/g/google-glog/libgoogle-glog0_0.3.3-2_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/i/icu/libicu52_52.1-5_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/universe/j/jemalloc/libjemalloc1_3.6.0-2_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/universe/libm/libmcrypt/libmcrypt4_2.5.8-3.1ubuntu1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/libm/libmemcached/libmemcached10_1.0.8-1ubuntu2_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/universe/libo/libonig/libonig2_5.9.5-2_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/universe/t/tbb/libtbb2_4.2~20130725-1.1ubuntu1_amd64.deb
http://mirrors.kernel.org/ubuntu/pool/main/libu/libunwind/libunwind8_1.1-3ubuntu1_amd64.deb"

for dep in $deps; do
    depb=$(basename $dep)
    echo "        - $depb"
    curl -LO $dep
    dpkg -x $depb ${BUILD_DIR}
done


echo " done"

if [ "${PIPESTATUS[*]}" != "0" ]; then
  echo " !     Failed to install ${JULIA_DIST}"
  exit 1
fi