#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

PROFILE_PATH=".profile.d/julia.sh"

set-env() {
  echo "export $1=$2" >> $PROFILE_PATH
}

# parse args
BUILD_DIR=$1
CACHE_DIR=$2

BP_DIR=`cd $(dirname $0); cd ..; pwd`

cd ${BUILD_DIR}

set-env LD_LIBRARY_PATH="/app/.apt/usr/lib/libblas/:/app/.apt/usr/lib/lapack/:$LD_LIBRARY_PATH"
set-env LIBRARY_PATH="/app/.apt/usr/lib/libblas/:/app/.apt/usr/lib/lapack/:$LIBRARY_PATH"

# these are not presistent in heroku
julia -e "Pkg.update()"
while IFS='' read -r julia_dep || [[ -n "$julia_dep" ]]; do
  if [[ $julia_dep == git* ]]; then
    echo 'in clone'
    julia -e "Pkg.clone(\"$julia_dep\")"
  else
    array=( $julia_dep )
    if [[ ${#array[@]} > 1 ]]; then
        julia -e "Pkg.add(\"${array[0]}\")"
        julia -e "Pkg.pin(\"${array[0]}\",v\"${array[1]}\")"
    else
        julia -e "Pkg.add(\"$julia_dep\")"
    fi
  fi
done < "REQUIRE"

cp -r ~/.julia ${BUILD_DIR}/.julia
